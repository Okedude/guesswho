<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das Gleiche Raten - Das Spiel</title>
    <!-- Tailwind CSS laden -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container-card {
            background: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            max-width: 90%;
            width: 500px;
        }
        .btn-primary {
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, runTransaction, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Deaktivieren Sie dies, um Debugging-Meldungen im Browser zu sehen
        setLogLevel('silent'); 

        // GLOBALE VARIABLEN (vom Canvas-Host bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, app;
        let userId = null;
        let isAuthReady = false;
        let currentLobbyCode = null;

        // Spielkonstanten: Name und zugehörige Tipps (aktualisiert)
        const NAME_POOL = [
            { name: "Nila", tips: ["Ist offen und hilfsbereit.", "Hat blonde Haare.", "Trägt Ohrringe.", "Ist mittelgross und gehört zur 6erGruppe."] },
            { name: "Adriana S.", tips: ["Hat braune Haare und braune Augen.", "Nutzt ein Moncler Brillenetui.", "Ist Mitglied der 6erGruppe.", "Eher unauffällig in der Gruppe."] },
            { name: "Ellison", tips: ["Ist politisch engagiert.", "Ist blond und hat Sommersprossen.", "Ist Amerikanisch.", "Gehört zur 6erGruppe."] },
            { name: "Julia", tips: ["Hat braune Haare.", "Hat immer Skyr dabei.", "Interessiert sich für Sherlock Holmes.", "Gehört zur ElisaGruppe."] },
            { name: "Tim", tips: ["Hat braunschwarze Haare und braune Augen.", "Ist sehr lustig.", "Kann als Konsumopfer bezeichnet werden.", "Steht auf Frau Elseners Liste (vermutlich für Unfug)."] },
            { name: "William", tips: ["Hat braune Haare.", "War in der Mongolei.", "Ist lustig und spielt gerne Schach.", "Kommt aus England und hat eine grosse Stirn."] },
            { name: "Jacob", tips: ["Ist fast immer am Computer.", "Hat braune Haare und trägt Openfront.", "Hat einen Bruder mit Autismus.", "Trägt einen schwarzen Schulthek."] },
            { name: "Tim-Oliver", tips: ["Ist immer am Lernen.", "Trägt immer eine Mütze.", "Hat braune Haare.", "Seine Zusammenfassungen sind sehr detailliert (wie eine Maturaarbeit)."] },
            { name: "Leif", tips: ["Gamt oft mit Jacob.", "Macht eigene Musik.", "Ist blond und gehört zur MaxGruppe.", "Sagt oft \"Ich bin perfekt!\" und ist ein Grillmeister."] },
            { name: "Max", tips: ["Ist neu in der Klasse.", "Ist gross und hat braune Haare.", "Ist Coiffeur (Friseur).", "Gehört zur LeifGruppe."] },
            { name: "Tais", tips: ["Ist neu in der Klasse.", "Spricht Französisch.", "Behauptet, er kann Mathe perfekt.", "Lebt bei Elisa."] },
            { name: "Elisa", tips: ["Hat blonde Haare und ist klein.", "Kann als Konsumopfer gelten.", "Gehört zur ElinGruppe.", "Hat kürzlich einen neuen Pulli gekauft."] },
            { name: "Zofia", tips: ["Ist immer mit Emma E. zusammen.", "Ist klein, blond und hat lange Haare.", "Ist eine Streberin.", "Liebt das Fach Mathematik."] },
            { name: "Elin", tips: ["Hat einen 20m Pool.", "Hat blondbraune Haare.", "Wurde im Bergwaldprojekt sofort krank.", "Trägt eine Moncler Jacke."] },
            { name: "Cedric", tips: ["Ist GC Fan (Grasshopper Club Zürich).", "Spielt Fussball.", "Gehört zur 6erGruppe.", "Hat braune Haare und ist gross."] },
            { name: "Luc", tips: ["Bestellt viel.", "Hat einen Buzzcut.", "Trägt eine Arc'teryx Jacke.", "Gehört zur 6erGruppe und hat braune Haare."] },
            { name: "Sean", tips: ["Trägt meistens Ralph Lauren.", "Hat einen Mittelscheitel.", "Hat blonde Haare und gehört zur 6erGruppe.", "Ist der beste Freund von Luc."] },
            { name: "Anna G.", tips: ["Ist immer auf GrowMyGarden.", "Spielt Poki.", "Hat Style und ist blond.", "Wird als \"fast provisorisch\" beschrieben."] },
            { name: "Anna P.", tips: ["Hat lange, braune Haare.", "Hat \"Glupschaugen\".", "Ist immer auf Poki.", "Ist die beste Freundin von Anna G."] },
            { name: "Jara", tips: ["Spielt auch immer Poki.", "Hat blondbraune Haare.", "Hat mittellange Haare.", "Besitzt ein ThinkPad."] }
        ];
        
        // --- UTILITY-FUNKTIONEN ---

        // Generiert einen zufälligen 3-stelligen Code
        function generateLobbyCode() {
            return Math.floor(100 + Math.random() * 900).toString();
        }

        /**
         * Wählt eine zufällige Person und einen zufälligen von vier Tipps aus.
         * @returns {{name: string, description: string}} Das Ziel-Objekt mit Name und einzelnem Tipp.
         */
        function getRandomTarget() {
            const randomIndex = Math.floor(Math.random() * NAME_POOL.length);
            const targetPerson = NAME_POOL[randomIndex];

            // Wähle zufällig einen von 4 Tipps (Index 0 bis 3)
            const randomTipIndex = Math.floor(Math.random() * 4); 
            const selectedTip = targetPerson.tips[randomTipIndex];
            
            return { 
                name: targetPerson.name, 
                description: selectedTip // description ist jetzt der einzelne, zufällige Tipp
            };
        }

        // Holt den Pfad zum Lobby-Dokument
        function getLobbyDocRef(code) {
            return doc(db, `/artifacts/${appId}/public/data/lobbies`, code);
        }

        // Zeigt eine Nachricht im UI an (ersetzt alert())
        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.className = `p-3 rounded-xl mb-4 text-center text-sm font-medium ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // --- FIREBASE INITIALISIERUNG & AUTHENTIFIZIERUNG ---

        function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase-Konfiguration nicht gefunden. Firestore wird nicht funktionieren.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Angemeldet als:", userId);
                    } else {
                        // Anonyme Anmeldung, wenn kein Token verfügbar ist
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    if (isAuthReady) {
                        renderScreen();
                    }
                });
            } catch (e) {
                console.error("Fehler bei der Firebase-Initialisierung:", e);
                showMessage("Fehler beim Starten der Datenbank.", true);
            }
        }

        // --- LOBBY-OPERATIONEN ---

        async function createLobby() {
            if (!isAuthReady) return showMessage("Authentifizierung läuft noch...", true);

            const lobbyCode = generateLobbyCode();
            const displayName = document.getElementById('display-name').value.trim();
            if (displayName.length < 2) {
                return showMessage("Bitte geben Sie einen gültigen Namen ein.", true);
            }

            const lobbyRef = getLobbyDocRef(lobbyCode);
            const initialPlayer = {
                name: displayName,
                streak: 0,
                lastGuess: null,
                id: userId
            };

            const lobbyData = {
                code: lobbyCode,
                target: getRandomTarget(), // Speichert jetzt das Ziel-Objekt {name, description (1 Tip)}
                createdAt: Date.now(),
                hostId: userId,
                players: { [userId]: initialPlayer }
            };

            try {
                await setDoc(lobbyRef, lobbyData);
                currentLobbyCode = lobbyCode;
                showMessage(`Lobby ${lobbyCode} erstellt!`);
                attachLobbyListener(lobbyCode);
            } catch (e) {
                console.error("Fehler beim Erstellen der Lobby:", e);
                showMessage("Fehler beim Erstellen der Lobby. Versuchen Sie es erneut.", true);
            }
        }

        async function joinLobby() {
            if (!isAuthReady) return showMessage("Authentifizierung läuft noch...", true);

            const code = document.getElementById('join-code').value.trim();
            const displayName = document.getElementById('display-name').value.trim();

            if (code.length !== 3 || displayName.length < 2) {
                return showMessage("Gültigen 3-stelligen Code und Namen eingeben.", true);
            }

            const lobbyRef = getLobbyDocRef(code);

            try {
                await runTransaction(db, async (transaction) => {
                    const lobbyDoc = await transaction.get(lobbyRef);

                    if (!lobbyDoc.exists()) {
                        throw new Error("Lobby nicht gefunden.");
                    }

                    const lobbyData = lobbyDoc.data();
                    const players = lobbyData.players || {};

                    // Spieler zur Lobby hinzufügen (oder aktualisieren)
                    if (!players[userId]) {
                        players[userId] = {
                            name: displayName,
                            streak: 0,
                            lastGuess: null,
                            id: userId
                        };
                    } else {
                        players[userId].name = displayName; // Namen aktualisieren, falls gewünscht
                    }

                    transaction.update(lobbyRef, { players: players });
                });

                currentLobbyCode = code;
                showMessage(`Lobby ${code} beigetreten!`);
                attachLobbyListener(code);

            } catch (e) {
                console.error("Fehler beim Beitreten der Lobby:", e);
                showMessage(e.message === "Lobby nicht gefunden." ? "Lobby-Code ungültig." : "Fehler beim Beitreten der Lobby.", true);
            }
        }

        // --- SPIELLOGIK ---

        async function submitGuess() {
            if (!currentLobbyCode || !isAuthReady) return showMessage("Keine aktive Lobby.", true);

            const guessInput = document.getElementById('guess-input');
            const userGuess = guessInput.value.trim();
            guessInput.value = ''; // Eingabe löschen

            // Prüfen, ob der geratene Name überhaupt in der Liste der gültigen Namen ist
            const validNames = NAME_POOL.map(n => n.name.toLowerCase());
            if (!validNames.includes(userGuess.toLowerCase())) {
                return showMessage("Ungültiger Name. Wähle aus der Liste.", true);
            }
            
            const lobbyRef = getLobbyDocRef(currentLobbyCode);

            try {
                await runTransaction(db, async (transaction) => {
                    const lobbyDoc = await transaction.get(lobbyRef);
                    if (!lobbyDoc.exists()) throw new Error("Lobby existiert nicht mehr.");

                    const lobbyData = lobbyDoc.data();
                    const players = lobbyData.players || {};
                    const target = lobbyData.target; // Das Ziel-Objekt {name, description}
                    const targetName = target.name; // Der tatsächliche Zielname
                    
                    if (!players[userId]) throw new Error("Spieler nicht in Lobby gefunden.");
                    
                    const player = players[userId];
                    const guessCorrect = userGuess.toLowerCase() === targetName.toLowerCase();

                    if (guessCorrect) {
                        player.streak += 1;
                        // NEUE RUNDE STARTEN: Wählt neues Ziel-Objekt (neue Person + neuer zufälliger Tip)
                        const newTarget = getRandomTarget(); 
                        lobbyData.target = newTarget;
                        
                        showMessage(`Korrekt! Der Name war ${targetName}. Dein Streak: ${player.streak}. Ein neuer Name wurde gewählt!`);
                    } else {
                        // Bei falscher Rateung den Streak zurücksetzen
                        player.streak = 0;
                        showMessage(`Falsch! Der Streak wurde zurückgesetzt. Der gesuchte Name war ${targetName}. Versuche es erneut!`);
                    }

                    player.lastGuess = userGuess;
                    
                    // Aktualisieren Sie den Spieler und das neue Ziel-Objekt
                    players[userId] = player;
                    transaction.update(lobbyRef, { 
                        players: players, 
                        target: lobbyData.target // Das gesamte Ziel-Objekt wird aktualisiert
                    });
                });
            } catch (e) {
                console.error("Fehler beim Raten:", e);
                showMessage("Fehler beim Raten: " + e.message, true);
            }
        }


        // --- ECHTZEIT-LISTENER & RENDERING ---

        function attachLobbyListener(code) {
            const lobbyRef = getLobbyDocRef(code);

            onSnapshot(lobbyRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const lobbyData = docSnapshot.data();
                    currentLobbyCode = code;
                    renderGameScreen(lobbyData);
                } else {
                    currentLobbyCode = null;
                    showMessage("Lobby wurde geschlossen oder existiert nicht mehr.", true);
                    renderLobbyScreen();
                }
            }, (error) => {
                console.error("Snapshot-Fehler:", error);
                showMessage("Verbindungsfehler zur Lobby. Zurück zur Startseite.", true);
                currentLobbyCode = null;
                renderLobbyScreen();
            });
        }

        // Haupt-Rendering-Funktion
        function renderScreen() {
            if (currentLobbyCode) {
                // Wir haben bereits einen Listener, der den GameScreen rendert
                // Beim ersten Laden zeigen wir nur den Ladebildschirm
                document.getElementById('app-container').innerHTML = `
                    <div class="text-center p-8">
                        <svg class="animate-spin h-5 w-5 mr-3 inline text-green-500" viewBox="0 0 24 24"></svg>
                        <span class="text-gray-600">Lobby-Daten werden geladen...</span>
                    </div>
                `;
            } else {
                renderLobbyScreen();
            }
        }

        function renderLobbyScreen() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Das Gleiche Raten</h1>
                
                <div id="message-box" style="display:none;"></div>

                <!-- Display Name Eingabe -->
                <div class="mb-6">
                    <label for="display-name" class="block text-sm font-medium text-gray-700 mb-2">Dein Name</label>
                    <input type="text" id="display-name" placeholder="Gib deinen Spielernamen ein" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500" maxlength="15">
                </div>

                <!-- Lobby Erstellen -->
                <div class="p-6 bg-green-50 border border-green-200 rounded-2xl mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-green-800">Lobby erstellen</h2>
                    <button id="create-lobby-btn" class="btn-primary w-full bg-green-500 text-white p-3 rounded-xl font-bold">Neue Lobby starten</button>
                </div>

                <!-- Lobby Beitreten -->
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-3 text-blue-800">Lobby beitreten</h2>
                    <div class="flex space-x-3">
                        <input type="text" id="join-code" placeholder="3-stelliger Code" class="flex-grow p-3 border border-gray-300 rounded-xl text-center text-lg font-mono tracking-widest" maxlength="3">
                        <button id="join-lobby-btn" class="btn-primary bg-blue-500 text-white p-3 rounded-xl font-bold px-6">Beitreten</button>
                    </div>
                </div>
            `;
            
            document.getElementById('create-lobby-btn').addEventListener('click', createLobby);
            document.getElementById('join-lobby-btn').addEventListener('click', joinLobby);
            
            // Lade den gespeicherten Namen
            const storedName = localStorage.getItem('displayName');
            if (storedName) {
                document.getElementById('display-name').value = storedName;
            }
            document.getElementById('display-name').addEventListener('input', (e) => {
                localStorage.setItem('displayName', e.target.value);
            });
        }

        function renderGameScreen(lobbyData) {
            const container = document.getElementById('app-container');
            const playersArray = Object.values(lobbyData.players || {}).sort((a, b) => b.streak - a.streak);
            const currentPlayer = playersArray.find(p => p.id === userId);

            // NEU: Zugriff auf den einzelnen, zufälligen Tipp
            const targetDescription = lobbyData.target ? lobbyData.target.description : "Beschreibung wird geladen...";

            // Datalist-Optionen für visuelle Vorschläge
            const nameOptions = NAME_POOL.map(item => 
                `<option value="${item.name}">${item.name}</option>`
            ).join('');

            const leaderboardHTML = playersArray.map((player, index) => `
                <li class="flex justify-between items-center p-3 rounded-lg ${player.id === userId ? 'bg-green-100 font-bold text-green-800 border-l-4 border-green-500' : 'bg-gray-50 border border-gray-200'}">
                    <span class="text-sm md:text-base">${index + 1}. ${player.name} ${player.id === userId ? '(Du)' : ''}</span>
                    <span class="text-lg font-extrabold text-indigo-600">${player.streak} <span class="text-sm font-normal text-gray-500">Streak</span></span>
                </li>
            `).join('');

            container.innerHTML = `
                <h1 class="text-2xl font-bold mb-2 text-gray-800">Lobby-Code: ${lobbyData.code}</h1>
                <p class="text-gray-500 mb-6">Finde den geheimen Namen basierend auf dem Hinweis.</p>
                
                <div id="message-box" style="display:none;"></div>

                <!-- Rundeninformation mit Beschreibung (jetzt Einzel-Tipp) -->
                <div class="p-6 bg-indigo-50 border border-indigo-200 rounded-2xl mb-6">
                    <h2 class="text-xl font-bold text-indigo-800 mb-2">Hinweis zur gesuchten Person:</h2>
                    <p class="text-base text-indigo-700 font-medium italic">${targetDescription}</p>
                    
                    <div class="mt-4 pt-4 border-t border-indigo-200 text-center">
                        <p class="text-sm text-indigo-600">Dein aktueller Streak:</p>
                        <span class="text-3xl font-extrabold text-indigo-900">${currentPlayer ? currentPlayer.streak : 0}</span>
                    </div>
                </div>

                <!-- Rate-Eingabe (Textfeld) -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">Dein Tipp</h2>
                    <div class="flex space-x-3">
                        <input type="text" id="guess-input" 
                               placeholder="Name hier eingeben (z.B. Nila)" 
                               list="name-options" 
                               class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Datalist bietet visuelle Vorschläge, erzwingt aber keine Auswahl -->
                        <datalist id="name-options">
                            ${nameOptions}
                        </datalist>
                        <button id="submit-guess-btn" class="btn-primary bg-indigo-500 text-white p-3 rounded-xl font-bold px-6">Raten</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Du musst den Namen aus der Liste korrekt eingeben.</p>
                </div>

                <!-- Leaderboard -->
                <div class="p-6 bg-white border border-gray-200 rounded-2xl">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                        Leaderboard 
                        <svg class="w-5 h-5 ml-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5-8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm3-4a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </h2>
                    <ul class="space-y-2">
                        ${leaderboardHTML}
                    </ul>
                </div>
                
                <button id="leave-lobby-btn" class="mt-6 w-full text-center text-sm text-gray-500 hover:text-red-500 transition duration-150">Lobby verlassen</button>
            `;

            document.getElementById('submit-guess-btn').addEventListener('click', submitGuess);
            document.getElementById('leave-lobby-btn').addEventListener('click', () => {
                currentLobbyCode = null;
                renderLobbyScreen();
                showMessage("Du hast die Lobby verlassen.", true);
            });
        }

        // --- APP START ---
        window.onload = initFirebase;

        // Macht die Funktionen global, damit sie von HTML-Elementen aufgerufen werden können
        // (Obwohl wir hauptsächlich Event-Listener verwenden, ist dies eine Sicherheitsmaßnahme)
        window.createLobby = createLobby;
        window.joinLobby = joinLobby;
        window.submitGuess = submitGuess;
    </script>
</head>
<body class="flex items-center justify-center p-4">
    <main class="container-card p-8">
        <div id="app-container">
            <!-- Ladeanzeige beim Start -->
            <div class="text-center p-8">
                <svg class="animate-spin h-5 w-5 mr-3 inline text-green-500" viewBox="0 0 24 24"></svg>
                <span class="text-gray-600">Wird geladen...</span>
            </div>
        </div>
    </main>
</body>
</html>

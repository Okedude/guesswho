<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wer Bin Ich? & Zimmerordnung</title>
    <!-- Tailwind CSS laden -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container-card {
            background: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            max-width: 95%;
            width: 1000px; 
        }
        .btn-primary {
            transition: all 0.15s ease-in-out;
            border: 2px solid;
            background-color: #4f46e5; /* indigo-600 */
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }
        .btn-disabled {
            background-color: #a5b4fc; /* indigo-300 */
            cursor: not-allowed;
        }
        .draggable-person {
            cursor: grab;
        }
        .drop-zone {
            min-height: 4rem;
            border: 2px dashed #9ca3af; /* gray-400 */
            transition: background-color 0.2s;
        }
        .drop-zone.drag-over {
            background-color: #eef2ff; /* indigo-50 */
            border-color: #4f46e5; /* indigo-600 */
        }
        .conflict-new {
             background-color: #fee2e2; /* red-100 */
             border: 1px solid #f87171; /* red-400 */
             padding: 0.25rem 0.5rem;
             border-radius: 0.5rem;
             font-size: 0.8rem;
             cursor: help; /* Zeigt an, dass es interaktiv ist */
             transition: background-color 0.15s;
        }
        .conflict-new:hover {
            background-color: #fca5a5; /* red-300 */
        }
        .room-card {
            transition: border 0.2s, box-shadow 0.2s;
        }
        .management-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: background-color 0.15s;
        }
        .sick-person {
             background-color: #fca5a5 !important; /* red-300 */
             color: #7f1d1d !important; /* red-900 */
        }
        .lehrer-zimmer {
            background-color: #fffbeb !important; /* yellow-50 */
            border-color: #fbbf24 !important; /* amber-400 */
        }
    </style>
</head>
<body class="flex items-start justify-center p-4">

    <main class="container-card p-8 mt-8">
        <div id="app-container">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Klassenfahrt Spiele</h1>
            
            <div id="mode-switcher" class="flex justify-center space-x-4 mb-6">
                <button id="switch-guess" data-mode="guess" class="px-4 py-2 font-semibold rounded-lg border border-indigo-500 text-indigo-700 hover:bg-indigo-50">
                    Wer Bin Ich?
                </button>
                <button id="switch-room" data-mode="room" class="px-4 py-2 font-semibold rounded-lg bg-indigo-500 text-white shadow-md">
                    Zimmerordnung
                </button>
            </div>
            
            <div id="message-box" style="display:none;"></div>

            <div id="guess-game" style="display:none;">
                <!-- Wer Bin Ich? (RATESPIEL) - Nicht relevant -->
            </div>

            <div id="room-game" style="display:block;">
                <!-- Zimmerordnung (ZUORDNUNGSSPIEL) -->
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Zimmerordnung & Virenmanagement</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <!-- Status und Zeit -->
                    <div id="room-status" class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-sm text-yellow-800 font-medium space-y-1 col-span-1">
                        <p class="font-bold text-base text-gray-700 mb-1">Logistik-Status</p>
                        <p>Total Zimmer: <span id="total-rooms">0</span></p>
                        <p class="font-bold text-green-700">Gesamtkapazit√§t: <span id="used-capacity">0</span> von <span id="total-capacity">0</span></p>
                        <p class="border-t border-yellow-200 pt-2 mt-2 font-bold">Verstrichene Zeit: <span id="room-timer" class="font-extrabold text-xl text-red-600">0s</span></p>
                    </div>
                    
                    <!-- Krankheitsstatus -->
                    <div class="p-4 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800 font-medium col-span-1">
                        <p class="font-bold text-base text-gray-700 mb-2">Krankheits-Status (Achtung!)</p>
                        <p>Kranke Personen ü§í: <span id="sick-count" class="font-extrabold text-red-700 text-lg">0</span> von 20</p>
                        <p class="text-xs mt-2 border-t border-red-200 pt-2 text-red-700">Krank: <span id="sick-list"></span></p>
                    </div>

                    <!-- Statische Konflikte -->
                    <div id="dynamic-conflict-area" class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl text-sm text-indigo-800 font-medium col-span-1">
                        <p class="font-bold text-base text-gray-700 mb-2">Aktive Konflikte (Statisch: <span id="active-conflict-count">0</span>)</p>
                        <div id="dynamic-conflicts-list" class="flex flex-wrap gap-2 h-10 overflow-y-auto">
                            <p class="text-xs italic text-indigo-600">Lade Konflikte...</p>
                        </div>
                         <p class="text-xs mt-2 border-t border-indigo-200 pt-2 text-indigo-700">
                             Hinweis: Konflikte sind Feste Beziehungen. Klicken f√ºr Hintergrund.
                        </p>
                    </div>
                </div>
                
                <div class="p-3 bg-blue-100 border border-blue-400 rounded-xl mb-6 text-sm text-blue-800">
                    <p class="font-bold mb-1">Regeln:</p>
                    <ul class="list-disc ml-4">
                        <li>Kranke (ü§í) d√ºrfen in Zimmer, aber **nicht** mit Gesunden.</li>
                        <li>Der Virus breitet sich im Flur aus, wenn **Kranke im Heim** sind und **mehrere T√ºren offen** stehen.</li>
                        <li>Cedric, Leif und Tais sind frei zuweisbar.</li>
                        <li>Adriana S., Nila, Sean und Luc brauchen keine Heizung.</li>
                    </ul>
                </div>
                
                <!-- DEDIZIERTER BEREICH F√úR KONFLIKTGESCHICHTEN -->
                 <div id="conflict-story-display" class="p-3 bg-red-50 border border-red-300 rounded-xl mb-6 text-sm text-red-800" style="display:none;">
                    <p class="font-bold mb-1 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Konflikt-Hintergrund: <span id="conflict-pair-display" class="font-extrabold ml-1"></span>
                    </p>
                    <p id="conflict-reason-text" class="text-xs"></p>
                </div>


                <!-- Personen zum Zuweisen -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Unzugewiesene Personen (<span id="unassigned-count">20</span>)</h3>
                    <div id="unassigned-persons" class="flex flex-wrap gap-2 p-3 bg-gray-100 rounded-xl drop-zone border-gray-300">
                        <!-- Personen-Tags werden hier eingef√ºgt -->
                    </div>
                </div>

                <!-- Zimmer-Container -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700">Zimmerplan (Kranke und Gesunde m√ºssen getrennt werden!)</h3>
                    <div id="room-layout" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <!-- Zimmer werden hier eingef√ºgt -->
                    </div>
                </div>
                
                <!-- Bewertungs-Button -->
                <button id="submit-rooms-btn" class="mt-6 w-full btn-primary text-white p-3 rounded-xl font-bold px-6 border-indigo-500">
                    Zimmerordnung absenden & Final bewerten
                </button>

                <button id="new-room-game-btn" class="mt-4 w-full text-center text-sm text-gray-500 hover:text-indigo-500 transition duration-150">
                    Neue Zimmerordnung starten
                </button>
                
                <div id="room-results" class="mt-6 p-4 border rounded-xl" style="display:none;">
                    <h3 class="text-xl font-bold mb-2">Bewertungsergebnis</h3>
                    <p id="room-result-text"></p>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- ALLGEMEINE SPIELKONSTANTEN ---
        const NAME_POOL_GUESS = [
            // Namen wie zuvor
            { name: "Nila", tips: ["Ist offen und hilfsbereit.", "Hat blonde Haare."] },
            { name: "Adriana S.", tips: ["Hat braune Haare und braune Augen.", "Nutzt ein Moncler Brillenetui."] },
            { name: "Ellison", tips: ["Ist politisch engagiert.", "Ist blond und hat Sommersprossen."] },
            { name: "Julia", tips: ["Hat braune Haare.", "Hat immer Skyr dabei."] },
            { name: "Tim", tips: ["Ist sehr lustig.", "Kann als Konsumopfer bezeichnet werden."] },
            { name: "William", tips: ["War in der Mongolei.", "Ist lustig und spielt gerne Schach."] },
            { name: "Jacob", tips: ["Ist fast immer am Computer.", "Tr√§gt einen schwarzen Schulthek."] },
            { name: "Tim-Oliver", tips: ["Ist immer am Lernen.", "Tr√§gt immer eine M√ºtze."] },
            { name: "Leif", tips: ["Macht eigene Musik.", "Sagt oft \"Ich bin perfekt!\"."] },
            { name: "Max", tips: ["Ist neu in der Klasse.", "Ist Coiffeur (Friseur)."] },
            { name: "Tais", tips: ["Spricht Franz√∂sisch.", "Behauptet, er kann Mathe perfekt."] },
            { name: "Elisa", tips: ["Hat blonde Haare und ist klein.", "Kann als Konsumopfer gelten."] },
            { name: "Zofia", tips: ["Ist immer mit Emma E. zusammen.", "Liebt das Fach Mathematik."] },
            { name: "Elin", tips: ["Hat einen 20m Pool.", "Wurde im Bergwaldprojekt sofort krank."] },
            { name: "Cedric", tips: ["Ist GC Fan (Grasshopper Club Z√ºrich).", "Spielt Fussball."] },
            { name: "Luc", tips: ["Bestellt viel.", "Hat einen Buzzcut."] },
            { name: "Sean", tips: ["Tr√§gt meistens Ralph Lauren.", "Hat einen Mittelscheitel."] },
            { name: "Anna G.", tips: ["Ist immer auf GrowMyGarden.", "Spielt Poki."] },
            { name: "Anna P.", tips: ["Hat lange, braune Haare.", "Ist immer auf Poki."] },
            { name: "Jara", tips: ["Spielt auch immer Poki.", "Besitzt ein ThinkPad."] }
        ];

        // --- ZIMMERORDNUNG KONSTANTEN ---
        const CLASS_SIZE = 20;
        const PERSON_NAMES = NAME_POOL_GUESS.map(p => p.name);
        
        // Kombinierter Pool aus allen m√∂glichen Konflikten
        const CONFLICT_POOL_COMBINED = [
            ["Zofia", "Tim", "Tim hat Zofias Stifte f√ºr seine Doodles ohne Erlaubnis benutzt, was bei Zofia, die sehr ordentlich ist, zu einem Tobsuchtsanfall f√ºhrte. Der Konflikt dreht sich um Respekt vor Eigentum."], 
            ["Tim-Oliver", "Luc", "Luc h√∂rt seine Hip-Hop-Musik immer √ºber Lautsprecher, w√§hrend Tim-Oliver absolute Ruhe zum Lernen braucht. Ein unl√∂sbarer Konflikt zwischen Entspannung und Leistung."], 
            ["Ellison", "Jacob", "Ellison ist √ºberzeugt, dass man sich politisch engagieren muss, w√§hrend Jacob nur in seiner Computerwelt lebt und die echte Welt ignoriert. Dieser fundamentale Weltanschauungskonflikt kocht bei jeder Diskussion hoch."], 
            ["Adriana S.", "Anna G.", "Sie streiten sich seit dem 5. Schuljahr darum, wer das sch√∂nere Federm√§ppchen besitzt. Es ist ein eitler, aber tiefer Groll."], 
            ["Nila", "Jacob", "Nila ist sehr ordentlich und extrovertiert, Jacob ist chaotisch und introvertiert. Nila kann Jacobs Unordnung nicht ertragen, die sie als Zeichen von Respektlosigkeit interpretiert."], 
            ["Julia", "Tim", "Tim machte einen Witz √ºber Julias st√§ndigen Skyr-Konsum ('Du bist doch eine wandelnde Molkerei!'), was Julia zutiefst beleidigte."], 
            ["Ellison", "Tim", "Ellison ist Tim zu laut und Tim findet Ellisons st√§ndige moralische Appelle anstrengend. Es ist ein Konflikt der Lautst√§rke und des Temperaments."], 
            ["William", "Tim-Oliver", "William findet, dass Tim-Oliver zu verbissen lernt und das Leben verpasst. Tim-Oliver h√§lt William f√ºr einen Zeitverschwender. Die unterschiedliche Einstellung zur Zukunft f√ºhrt zu Spannung."], 
            ["Tim", "Tim-Oliver", "Sie sind Namensvetter, aber charakterliche Gegens√§tze. Tim √§rgert Tim-Oliver st√§ndig, indem er seine M√ºtze versteckt."],
            ["Max", "Adriana S.", "Max hat versehentlich Adriana S.'s neue, teure Sonnenbrille fallen gelassen und nicht sofort zugegeben. Adriana S. h√§lt Max f√ºr unverantwortlich."],
            ["Leif", "Cedric", "Cedric behauptete Leifs Musik sei 'nur L√§rm'. F√ºr Leif, dessen Musik sein Ein und Alles ist, ist das ein Kampf."],
            ["Zofia", "Nila", "Ein Streit um die beste Sitzordnung im Bus; Zofia wollte den Fensterplatz, den Nila bereits reserviert hatte. Sie sprechen seither nicht mehr miteinander."],
            ["Elin", "Adriana S.", "Elin erz√§hlte im Vertrauen ein Geheimnis, das Adriana S. versehentlich weitergab. Elin f√ºhlt sich verraten."],
            ["Tais", "Nila", "Tais behauptet Nila k√∂nne kein Franz√∂sisch, obwohl Tais selbst kein Muttersprachler ist. Es geht um Angeberei und Kompetenz-Anspr√ºche."],
            ["Elisa", "Cedric", "Elisa ist ver√§rgert, weil Cedric immer alle Witze √ºber das Konsumverhalten macht, die sie als pers√∂nliche Angriffe empfindet."],
            ["Cedric", "Tim", "Sie sind beide Fussballfans, aber Cedric ist GC Fan und Tim ist ein YB-Hasser. Der Konflikt ist rein sportlicher Natur, aber sehr emotional."],
            ["Sean", "Tim", "Tim hat Seans geliebtes Ralph-Lauren-Shirt mit einem Ketchup-Fleck ruiniert. Tim hat es nicht ersetzt, da er es 'nur lustig' fand."],
            ["Luc", "Tim", "Luc f√ºhlt sich von Tims st√§ndigen Witzen √ºber seinen Buzzcut pers√∂nlich angegriffen. Er sieht es als Mobbing."],
            ["Anna G.", "Ellison", "Anna G. findet Ellisons politisches Geschw√§tz zu viel, Ellison findet Anna G.'s st√§ndiges Poki-Spielen unproduktiv. Wieder ein Konflikt der Lebensphilosophien."],
            ["Anna P.", "Ellison", "√Ñhnlich wie bei Anna G., aber Anna P. wirft Ellison zus√§tzlich vor, 'zu perfekt' sein zu wollen."],
            ["Jara", "Ellison", "Ellison verspottete Jaras altes ThinkPad als 'Museumsst√ºck', was Jara verletzt hat, da es ein Geschenk war."],
            ["Max", "Jacob", "Max und Jacob stritten sich um den letzten Donut, der eigentlich f√ºr den Lehrer gedacht war. Gier besiegt Anstand."], 
            ["William", "Ellison", "Sie hatten eine hitzige Debatte dar√ºber, ob man nach dem Motto 'YOLO' leben sollte (William) oder ob das verantwortungslos ist (Ellison)."], 
            ["Tim", "Sean", "Tim hat sich √ºber Seans neuste, sehr teure Turnschuhe lustig gemacht, was Sean als extrem respektlos empfand."], 
            ["Julia", "Zofia", "Julia hat Zofia versehentlich in der Mensa angerempelt, was Zofia als absichtliche Provokation auffasste, da sie Julia nicht mag."],
            ["Cedric", "Elisa", "Elisa behauptet, Cedric w√ºrde immer die besten Pl√§tze im Bus reservieren, was Cedric als haltlose L√ºge abtut."],
            ["Leif", "Max", "Max fragte einmal, ob Leifs Musik √ºberhaupt 'echte Musik' sei, was Leifs K√ºnstlerseele tief traf."],
            ["Jara", "Tais", "Jara und Tais stritten sich stundenlang dar√ºber, ob Android oder iOS das √ºberlegene Betriebssystem sei."],
            ["Elin", "Tim", "Elin ist genervt von Tims Angewohnheit, st√§ndig mit Essen im Mund zu reden."],
            ["Adriana S.", "Luc", "Ein unbedachter Kommentar von Luc √ºber Adriana S.'s neue Jacke f√ºhrte zu tagelangem Schweigen."],
            ["Anna G.", "Max", "Max hat Anna G.'s Highscore in einem Online-Spiel geschlagen und ihr dann seine '√úberlegenheit' in einem Chat-Spam unter die Nase gerieben."],
            ["Julia", "Nila", "Ein Missverst√§ndnis √ºber eine Gruppenarbeit, bei der Nila dachte, Julia h√§tte ihre Arbeit gestohlen, obwohl Julia nur helfen wollte."],
            ["William", "Luc", "William findet Lucs Verhalten als 'zu viel' und Luc findet Williams lockere Art 'naiv'."],
        ];

        const INFECTION_CHECK_INTERVAL = 60 * 1000; // 60 Sekunden

        // --- GLOBALER SPIELSTATUS ---
        let gameState = 'room'; 
        
        // --- ROOM GAME STATUS (ERWEITERT) ---
        let rooms = [];
        let sickPersons = []; 
        let roomProblemIds = [];
        let activeConflicts = []; // Beinhaltet 3-10 statische Konflikte
        let roomStartTime = 0; 
        let roomTimerInterval = null; 
        let lastInfectionCheckTime = 0;
        
        // Management Status (Key: RoomID, Value: {lastVent, isDoorClosed, areMasksWorn})
        let roomManagementStatus = {};

        // --- HILFSFUNKTIONEN ---

        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.className = `p-3 rounded-xl mb-4 text-center text-sm font-medium ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Hilfsfunktion, um den Grund f√ºr ein spezifisches Paar zu finden
        function getConflictReason(personA, personB) {
            const foundConflict = activeConflicts.find(pair => 
                (pair[0] === personA && pair[1] === personB) || 
                (pair[0] === personB && pair[1] === personA)
            );
            return foundConflict ? foundConflict[2] : null; // Gibt den Grund zur√ºck
        }

        function isConflict(personA, personB) {
            return activeConflicts.some(pair => 
                (pair[0] === personA && pair[1] === personB) || 
                (pair[0] === personB && pair[1] === personA)
            );
        }

        function displayConflictStory(personA, personB, reason) {
            const displayBox = document.getElementById('conflict-story-display');
            const pairDisplay = document.getElementById('conflict-pair-display');
            const reasonText = document.getElementById('conflict-reason-text');
            
            if (reason) {
                pairDisplay.textContent = `${personA} ‚ÜîÔ∏è ${personB}`;
                reasonText.textContent = reason;
                displayBox.style.display = 'block';
            } else {
                displayBox.style.display = 'none';
            }
        }
        
        // Zuweisungs-Logik (vereinfacht, da Quests entfernt wurden)
        function assignPerson(personName, targetRoomId) {
            // 1. Aus altem Zimmer entfernen
            rooms.forEach(room => {
                const index = room.occupants.indexOf(personName);
                if (index > -1) {
                    room.occupants.splice(index, 1);
                }
            });
            
            // 2. Zu neuem Zimmer hinzuf√ºgen (wenn nicht unzugewiesen)
            if (targetRoomId !== 'unassigned-persons') {
                const targetRoom = rooms.find(r => r.id === targetRoomId);
                if (targetRoom && targetRoom.occupants.length < targetRoom.size) {
                    targetRoom.occupants.push(personName);
                } else if (targetRoom) {
                     showMessage(`Zimmer ${targetRoom.id.replace('room-', '')} ist bereits voll (${targetRoom.size}er).`, true);
                }
            } 
            // Wenn targetRoomId 'unassigned-persons' ist, wird die Person einfach nirgendwo hinzugef√ºgt (ist automatisch unzugewiesen).
            
            renderRoomGame();
        }
        
        // ===================================
        // ZIMMERORDNUNGS MODUS LOGIK (KERN)
        // ===================================

        function generateRoomLayout() {
            // Garantiert genau 20 Betten + 1 Notbett (Lehrerzimmer)
            const guaranteedSizes = [5, 5, 4, 3, 3]; 
            const shuffledSizes = guaranteedSizes.sort(() => 0.5 - Math.random());
            
            const generatedRooms = [];
            let roomId = 1;
            
            shuffledSizes.forEach(selectedSize => {
                generatedRooms.push({
                    id: `room-${roomId}`,
                    size: selectedSize,
                    occupants: [],
                    hasHeating: Math.random() < 0.5 // Heizung optional
                });
                roomId++;
            });
            
            // Hinzuf√ºgen des Lehrerzimmers
            generatedRooms.push({
                id: 'room-lehrer',
                size: 1,
                occupants: [],
                hasHeating: true,
                isTeacherRoom: true
            });

            rooms = generatedRooms;
        }

        function generateSickPersons() {
            const sickCount = Math.floor(Math.random() * 4) + 2; // 2 bis 5 Kranke
            const shuffledNames = [...PERSON_NAMES].sort(() => 0.5 - Math.random());
            sickPersons = shuffledNames.slice(0, sickCount);
        }
        
        function selectInitialConflicts() {
            // W√§hlt 3 bis 10 statische Konflikte aus
            const numConflicts = Math.floor(Math.random() * 8) + 3; // 3 bis 10
            const shuffledConflicts = [...CONFLICT_POOL_COMBINED].sort(() => 0.5 - Math.random());
            activeConflicts = shuffledConflicts.slice(0, numConflicts);
        }

        function updateRoomState() {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - roomStartTime) / 1000);
            
            // --- 1. Timer aktualisieren ---
            document.getElementById('room-timer').textContent = `${elapsedTime}s`;

            // --- 2. Viren-Ausbreitung (Alle 60s) ---
            if (currentTime - lastInfectionCheckTime >= INFECTION_CHECK_INTERVAL) {
                lastInfectionCheckTime = currentTime;
                
                const healthyPersons = PERSON_NAMES.filter(name => !sickPersons.includes(name));
                const newlyInfected = [];
                const sickPersonsExist = sickPersons.length > 0;
                
                // Z√§hle die Zimmer mit offenen T√ºren
                const openDoorsCount = rooms.filter(room => {
                    const status = roomManagementStatus[room.id];
                    return room.occupants.length > 0 && status.isDoorClosed === false;
                }).length;

                // 2.1 Spread im unzugewiesenen Bereich
                const unassignedPersons = getUnassignedPersons();
                const sickUnassigned = unassignedPersons.filter(name => sickPersons.includes(name));
                const healthyUnassigned = unassignedPersons.filter(name => healthyPersons.includes(name));
                
                if (sickUnassigned.length > 0) {
                    healthyUnassigned.forEach(name => {
                        if (Math.random() < 0.15) { // Erh√∂hte Gefahr im unzugewiesenen Chaos
                            newlyInfected.push(name);
                        }
                    });
                }
                
                // 2.2 Zimmer-Infektion (Flur-√úbertragung)
                rooms.forEach(room => {
                    const roomStatus = roomManagementStatus[room.id];
                    const sickRoom = room.occupants.filter(name => sickPersons.includes(name));
                    const healthyRoom = room.occupants.filter(name => healthyPersons.includes(name));
                    
                    // Fall 1: Gesunde und Kranke sind in einem Zimmer (Verletzung Regel A)
                    if (sickRoom.length > 0 && healthyRoom.length > 0) {
                        healthyRoom.forEach(name => {
                            if (Math.random() < 0.6) { // Sehr hohe Ansteckung im selben Zimmer
                                newlyInfected.push(name); 
                            }
                        });
                    } 
                    
                    // Fall 2: Flur-√úbertragung
                    const roomHasOpenDoor = !roomStatus.isDoorClosed;
                    
                    if (sickPersonsExist && healthyRoom.length > 0 && roomHasOpenDoor && openDoorsCount >= 2) {
                         healthyRoom.forEach(name => {
                            if (Math.random() < 0.4) { // Erh√∂hte Ansteckungsgefahr durch Flur-Luft
                                newlyInfected.push(name); 
                            }
                        });
                    }
                });
                
                newlyInfected.forEach(name => {
                    if (!sickPersons.includes(name)) {
                        sickPersons.push(name);
                        showMessage(`ü¶† VIRUS-ALARM! ${name} ist jetzt krank!`, true);
                    }
                });
                
                if (newlyInfected.length > 0) renderRoomGame(); 
            }
            
            document.getElementById('sick-count').textContent = sickPersons.length;
            document.getElementById('sick-list').textContent = sickPersons.join(', ');
        }
        
        function startRoomTimer() {
            stopRoomTimer(); 
            roomStartTime = Date.now();
            lastInfectionCheckTime = Date.now();
            roomTimerInterval = setInterval(updateRoomState, 1000);
            updateRoomState(); 
        }
        
        function stopRoomTimer() {
            if (roomTimerInterval) {
                clearInterval(roomTimerInterval);
                roomTimerInterval = null;
            }
        }
        
        function getUnassignedPersons() {
            const assignedPersons = rooms.flatMap(r => r.occupants);
            return PERSON_NAMES.filter(name => !assignedPersons.includes(name));
        }

        function setupRoomGame() {
            stopRoomTimer();
            generateRoomLayout();
            generateSickPersons();
            selectInitialConflicts(); 

            rooms.forEach(room => room.occupants = []);
            roomProblemIds = [];
            
            rooms.forEach(room => {
                roomManagementStatus[room.id] = {
                    lastVentTime: 0,
                    isDoorClosed: false,
                    areMasksWorn: false
                };
            });
            
            document.getElementById('conflict-story-display').style.display = 'none';

            renderRoomGame();
            startRoomTimer();
        }
        
        function renderConflictList() {
            const conflictListEl = document.getElementById('dynamic-conflicts-list');
            document.getElementById('active-conflict-count').textContent = activeConflicts.length;

            if (activeConflicts.length === 0) {
                 conflictListEl.innerHTML = '<p class="text-xs italic text-indigo-600">Keine Konflikte in dieser Runde!</p>';
            } else {
                conflictListEl.innerHTML = activeConflicts.map(([a, b, reason]) => 
                    `<span class="conflict-new" data-a="${a}" data-b="${b}" onclick="displayConflictStory('${a}', '${b}', '${reason.replace(/'/g, "\\'")}')">
                        ${a} &harr; ${b}
                    </span>`
                ).join('');
            }
        }

        function renderRoomGame() {
            renderConflictList();

            const assignedPersons = rooms.flatMap(r => r.occupants);
            const unassignedNames = PERSON_NAMES.filter(name => !assignedPersons.includes(name));
            const totalCapacity = rooms.reduce((sum, room) => sum + room.size, 0);
            const currentTime = Date.now();

            // Update Status Display
            document.getElementById('total-capacity').textContent = totalCapacity;
            document.getElementById('used-capacity').textContent = assignedPersons.length;
            document.getElementById('unassigned-count').textContent = unassignedNames.length;
            document.getElementById('total-rooms').textContent = rooms.length;
            document.getElementById('sick-count').textContent = sickPersons.length;
            document.getElementById('sick-list').textContent = sickPersons.join(', ');

            // Rendere Unzugewiesene Personen
            const unassignedContainer = document.getElementById('unassigned-persons');
            unassignedContainer.innerHTML = unassignedNames.map(name => {
                const isSick = sickPersons.includes(name);
                
                let colorClass = isSick ? 'sick-person' : 'bg-indigo-500';
                
                return `
                    <span id="person-${name}" 
                          draggable="true" 
                          data-name="${name}" 
                          class="draggable-person px-3 py-1 text-xs font-semibold rounded-full text-white ${colorClass} shadow-sm transition hover:shadow-lg">
                        ${name} ${isSick ? 'ü§í' : ''}
                    </span>
                `;
            }).join('');
            
            // Rendere Zimmer
            const roomLayoutContainer = document.getElementById('room-layout');
            roomLayoutContainer.innerHTML = '';
            
            rooms.forEach((room, index) => {
                const status = roomManagementStatus[room.id];
                const isTeacherRoom = room.isTeacherRoom;
                const problemClass = roomProblemIds.includes(room.id) ? 'border-red-500 bg-red-50' : 'border-indigo-300 bg-white';
                const roomExtraClass = isTeacherRoom ? 'lehrer-zimmer' : '';
                const roomTitle = isTeacherRoom ? `Lehrerzimmer (Nothilfe)` : `Zimmer ${index + 1} (${room.size}er)`;
                
                const occupantsHTML = room.occupants.map(name => {
                    const isSick = sickPersons.includes(name);
                    
                    let colorClass = isSick ? 'sick-person' : 'bg-indigo-500';

                    return `
                        <span id="person-${name}" 
                              draggable="true" 
                              data-name="${name}" 
                              class="draggable-person px-3 py-1 text-xs font-semibold rounded-full text-white ${colorClass} shadow-sm transition hover:shadow-lg">
                            ${name} ${isSick ? 'ü§í' : ''}
                        </span>
                    `;
                }).join('');

                const timeSinceVent = Math.floor((currentTime - status.lastVentTime) / 1000);
                const isVented = timeSinceVent <= 60;
                const ventStatus = isVented ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';

                // NEUE HEIZUNGSREGEL (optional f√ºr alle, aber 4 Personen brauchen sie nicht)
                const requiresHeating = !['Adriana S.', 'Nila', 'Sean', 'Luc'].includes(...room.occupants);
                const heatingIcon = room.hasHeating ? 'üî•' : 'üßä';
                const heatingStatusText = room.hasHeating ? 'Heizung: Ja' : 'Heizung: Nein';
                const heatingStatusClass = room.hasHeating ? 'bg-green-100 text-green-700' : (requiresHeating && room.occupants.length > 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700');


                const roomHTML = `
                    <div id="${room.id}" 
                         data-room-id="${room.id}"
                         data-size="${room.size}"
                         class="drop-zone room-card p-4 rounded-xl border-2 ${problemClass} ${roomExtraClass} space-y-3">
                        
                        <h4 class="w-full text-sm font-bold text-gray-700">
                           ${roomTitle} - Belegt: ${room.occupants.length} / ${room.size}
                        </h4>
                        
                        <div class="p-2 rounded-lg text-xs font-semibold text-center ${heatingStatusClass}">
                            ${heatingIcon} ${heatingStatusText}
                        </div>


                        <!-- Management Controls -->
                        <div class="flex flex-wrap gap-2 justify-between border-t pt-2 border-gray-200">
                            <button onclick="toggleRoomManagement('${room.id}', 'vent', true)" 
                                    class="management-btn ${ventStatus}">
                                üå¨Ô∏è L√ºften (Vent: ${Math.min(timeSinceVent, 60)}s)
                            </button>

                            <button onclick="toggleRoomManagement('${room.id}', 'door', ${!status.isDoorClosed})" 
                                    class="management-btn ${status.isDoorClosed ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                                ${status.isDoorClosed ? 'üö™ Zu' : 'üö™ Offen'}
                            </button>

                            <button onclick="toggleRoomManagement('${room.id}', 'mask', ${!status.areMasksWorn})" 
                                    class="management-btn ${status.areMasksWorn ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                                ${status.areMasksWorn ? 'üò∑ Maske' : 'üôÅ Keine Maske'}
                            </button>
                        </div>

                        <!-- Occupants -->
                        <div class="flex flex-wrap gap-2 pt-2 min-h-[2rem]">
                            ${room.occupants.length === 0 ? '<p class="text-gray-400 text-sm italic">Personen hierher ziehen...</p>' : occupantsHTML}
                        </div>
                    </div>
                `;
                roomLayoutContainer.innerHTML += roomHTML;
            });
            
            if (roomProblemIds.length === 0) {
                 document.getElementById('room-results').style.display = 'none';
            }
            
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const draggables = document.querySelectorAll('.draggable-person');
            const dropZones = document.querySelectorAll('.drop-zone');

            draggables.forEach(person => {
                person.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.name);
                    setTimeout(() => person.classList.add('opacity-50'), 0);
                });

                person.addEventListener('dragend', (e) => {
                    e.target.classList.remove('opacity-50');
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', (e) => {
                    zone.classList.remove('drag-over');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    
                    const personName = e.dataTransfer.getData('text/plain');
                    const droppedOnRoomId = zone.id.startsWith('room-') ? zone.id : 'unassigned-persons';
                    
                    // F√ºhrt die Zuweisung direkt aus, da keine Quests mehr blockieren
                    assignPerson(personName, droppedOnRoomId);
                });
            });
        }

        function evaluateRooms() {
            stopRoomTimer();
            updateRoomState(); 
            
            roomProblemIds = [];
            const results = [];
            let allAssigned = true;
            let success = true;
            
            let firstConflictReason = null; 
            const currentTime = Date.now();

            // 1. Check, ob alle zugewiesen sind
            const unassignedCount = getUnassignedPersons().length;
            
            if (unassignedCount > 0) {
                results.push(`‚ùå ZUWEISUNGSFEHLER! ${unassignedCount} Person(en) sind unzugewiesen (${getUnassignedPersons().join(', ')}). ALLE m√ºssen in einem Zimmer sein.`);
                allAssigned = false;
                success = false;
            }
            
            // 2. Allgemeine Zimmer-Regeln und Konflikte
            let openDoorSickRoom = false; // Wird verwendet, um Regel C.2 zu pr√ºfen
            const openDoorsCount = rooms.filter(room => {
                const status = roomManagementStatus[room.id];
                return room.occupants.length > 0 && status.isDoorClosed === false;
            }).length;
            const sickUnassigned = getUnassignedPersons().filter(name => sickPersons.includes(name));

            rooms.forEach(room => {
                let roomProblem = false;
                let conflictPairsFound = [];
                const occupants = room.occupants;
                const status = roomManagementStatus[room.id];
                
                if (occupants.length === 0) {
                    if (!room.isTeacherRoom) {
                         results.push(`‚ö†Ô∏è Zimmer ${room.id.replace('room-', '')} ist leer. Dies verschwendet Betten, aber ist kein sofortiger Fehler.`);
                    }
                    return;
                }
                
                // Regel: Lehrerzimmer-Nutzung
                if (room.isTeacherRoom && occupants.length > 0) {
                    results.push(`‚ö†Ô∏è Zimmer ${room.id.replace('room-', '')}: Das Lehrerzimmer sollte nur in Notf√§llen belegt werden (grosse Abz√ºge).`);
                    // Macht die L√∂sung nicht sofort ung√ºltig, aber reduziert die Gesamtpunktzahl.
                }

                // Regel A: Krankheits-Isolation
                const sickInRoom = occupants.filter(name => sickPersons.includes(name));
                const healthyInRoom = occupants.length - sickInRoom.length;
                
                if (sickInRoom.length > 0 && healthyInRoom > 0) {
                    roomProblem = true;
                    results.push(`‚ùå Zimmer ${room.id.replace('room-', '')}: Kranke (${sickInRoom.join(', ')}) d√ºrfen NICHT mit Gesunden (${occupants.filter(n => !sickPersons.includes(n)).join(', ')}) zusammen sein.`);
                    success = false;
                }
                
                // Regel B: Soziale Konflikte
                for (let i = 0; i < occupants.length; i++) {
                    for (let j = i + 1; j < occupants.length; j++) {
                        const personA = occupants[i];
                        const personB = occupants[j];
                        
                        const isA_Sick = sickPersons.includes(personA);
                        const isB_Sick = sickPersons.includes(personB);

                        if (isA_Sick || isB_Sick) continue; 

                        if (isConflict(personA, personB)) {
                            if (!roomProblem) roomProblem = true;
                            conflictPairsFound.push(`${personA} & ${personB}`);
                            success = false;
                            
                            if (!firstConflictReason) {
                                firstConflictReason = {
                                    pair: `${personA} ‚ÜîÔ∏è ${personB}`,
                                    reason: getConflictReason(personA, personB)
                                };
                            }
                        }
                    }
                }
                
                if (conflictPairsFound.length > 0) {
                    results.push(`‚ùå Zimmer ${room.id.replace('room-', '')}: Soziale Konflikte gefunden (${conflictPairsFound.join(', ')}).`);
                }
                
                // Regel C.1: Einzel-Management Check (L√ºftung/Maske)
                const isVented = (currentTime - status.lastVentTime) < INFECTION_CHECK_INTERVAL;
                
                if (sickInRoom.length > 0) {
                    if (!status.areMasksWorn || !isVented) {
                        results.push(`‚ö†Ô∏è Zimmer ${room.id.replace('room-', '')}: Kranken-Management MANGELHAFT (Maske: ${status.areMasksWorn ? '‚úÖ' : '‚ùå'}, L√ºftung: ${isVented ? '‚úÖ' : '‚ùå'}).`);
                        // Keine Erfolgsreduzierung, da es ein Management-Problem ist
                    }
                    if (!status.isDoorClosed) {
                         openDoorSickRoom = true; // Setze Flag f√ºr Flur-√úberpr√ºfung
                    }
                }
                
                // Regel D: Heizung (NEUE REGEL)
                const noHeatingRequired = ['Adriana S.', 'Nila', 'Sean', 'Luc'];
                const occupantsNeedingHeating = occupants.filter(name => !noHeatingRequired.includes(name));

                if (!room.hasHeating && occupantsNeedingHeating.length > 0) {
                    results.push(`‚ö†Ô∏è Zimmer ${room.id.replace('room-', '')}: Keine Heizung verf√ºgbar. ${occupantsNeedingHeating.join(', ')} brauchen theoretisch eine.`);
                }


                if (roomProblem || (sickInRoom.length > 0 && (!status.areMasksWorn || !isVented))) {
                    if (!roomProblemIds.includes(room.id)) roomProblemIds.push(room.id);
                }
            });
            
            // Regel C.2: Flur-√úbertragung (NEUE REGEL)
            const sickPersonsExistInTotal = sickPersons.length > 0;
            if (sickPersonsExistInTotal && openDoorsCount >= 2 && (openDoorSickRoom || sickUnassigned.length > 0)) {
                 results.push(`‚ùå VIREN-RISIKO! Es sind Kranke in der Unterkunft UND ${openDoorsCount} T√ºren stehen offen. Viren√ºbertragung im Flur m√∂glich!`);
                 success = false;
            }

            // 3. Ausgabe des Ergebnisses
            const resultContainer = document.getElementById('room-results');
            const resultText = document.getElementById('room-result-text');
            const finalTime = document.getElementById('room-timer').textContent;

            if (firstConflictReason) {
                displayConflictStory(firstConflictReason.pair.split(' ‚ÜîÔ∏è ')[0], firstConflictReason.pair.split(' ‚ÜîÔ∏è ')[1], firstConflictReason.reason);
            } else {
                document.getElementById('conflict-story-display').style.display = 'none';
            }

            if (success && allAssigned && roomProblemIds.length === 0) { 
                resultContainer.className = 'mt-6 p-4 border border-green-500 bg-green-100 rounded-xl';
                resultText.innerHTML = `<span class="font-semibold text-lg">PERFEKT!</span> Die Zimmerordnung ist perfekt. Alle sind gl√ºcklich und gesund! Die Logistik dauerte nur: <span class="font-bold text-xl">${finalTime}</span>.`;
                stopRoomTimer();
            } else if (sickPersons.length > 10) {
                resultContainer.className = 'mt-6 p-4 border border-red-500 bg-red-100 rounded-xl';
                 resultText.innerHTML = `<span class="font-semibold text-lg">KATASROPHE!</span> √úber die H√§lfte der Klasse ist krank geworden (${sickPersons.length} Personen). Die Logistik ist gescheitert.`;
                 stopRoomTimer();
            } else {
                resultContainer.className = 'mt-6 p-4 border border-red-500 bg-red-100 rounded-xl';
                let output = `Es gibt Probleme in deiner Zimmerordnung: <span class="font-bold">(${sickPersons.length} Personen sind am Ende krank)</span>`;
                output += '<ul class="list-disc ml-5 mt-2 space-y-1">';
                
                results.forEach(msg => {
                    output += `<li>${msg}</li>`;
                });
                
                if (roomProblemIds.length > 0 && !results.some(msg => msg.includes('Probleme gefunden in den Zimmern'))) {
                    output += `<li class="font-semibold">Problematische Zimmer: ${roomProblemIds.map(id => id.replace('room-', '')).join(', ')}</li>`;
                }

                output += '</ul>';
                resultText.innerHTML = output;
            }
            
            resultContainer.style.display = 'block';
            renderRoomGame(); 
            // Timer muss weiterlaufen, um Virenverbreitung zu simulieren
            startRoomTimer();
        }


        // ===================================
        // ALLGEMEINE INITIALISIERUNG
        // ===================================

        function toggleRoomManagement(roomId, controlType, value) {
            if (!roomManagementStatus[roomId]) return;
            
            if (controlType === 'vent') {
                roomManagementStatus[roomId].lastVentTime = Date.now();
                showMessage(`Zimmer ${roomId.replace('room-', '').replace('lehrer', 'Lehrer')} gel√ºftet! N√§chste L√ºftung in 60s.`);
            } else if (controlType === 'door') {
                roomManagementStatus[roomId].isDoorClosed = value;
                showMessage(`Zimmer ${roomId.replace('room-', '').replace('lehrer', 'Lehrer')}: T√ºr ist jetzt ${value ? 'geschlossen' : 'offen'}.`);
            } else if (controlType === 'mask') {
                roomManagementStatus[roomId].areMasksWorn = value;
                showMessage(`Zimmer ${roomId.replace('room-', '').replace('lehrer', 'Lehrer')}: Masken sind jetzt ${value ? 'aufgesetzt' : 'abgesetzt'}.`);
            }
            renderRoomGame(); 
        }

        function switchMode(mode) {
            gameState = mode;
            const guessDiv = document.getElementById('guess-game');
            const roomDiv = document.getElementById('room-game');
            const guessBtn = document.getElementById('switch-guess');
            const roomBtn = document.getElementById('switch-room');
            
            if (mode === 'guess') {
                guessDiv.style.display = 'block';
                roomDiv.style.display = 'none';
                guessBtn.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
                guessBtn.classList.remove('border', 'border-indigo-500', 'text-indigo-700', 'hover:bg-indigo-50');
                roomBtn.classList.remove('bg-indigo-500', 'text-white', 'shadow-md');
                roomBtn.classList.add('border', 'border-indigo-500', 'text-indigo-700', 'hover:bg-indigo-50');
                stopRoomTimer();
            } else {
                guessDiv.style.display = 'none';
                roomDiv.style.display = 'block';
                roomBtn.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
                roomBtn.classList.remove('border', 'border-indigo-500', 'text-indigo-700', 'hover:bg-indigo-50');
                guessBtn.classList.remove('bg-indigo-500', 'text-white', 'shadow-md');
                guessBtn.classList.add('border', 'border-indigo-500', 'text-indigo-700', 'hover:bg-indigo-50');
                setupRoomGame();
            }
        }
        
        function initializeApp() {
            // Initialisiere Room Game Listeners
            document.getElementById('submit-rooms-btn').onclick = evaluateRooms;
            document.getElementById('new-room-game-btn').onclick = setupRoomGame;

            // Initialisiere Mode Switcher
            document.getElementById('switch-guess').onclick = () => switchMode('guess');
            document.getElementById('switch-room').onclick = () => switchMode('room');
            
            // Starte standardm√§ssig mit dem Zimmer-Modus
            switchMode('room');
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
